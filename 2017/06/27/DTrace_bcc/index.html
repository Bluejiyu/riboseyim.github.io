<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>动态追踪技术（四）：基于 Linux bcc/BPF 实现 Go 程序动态追踪 | Ribose Yim&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="摘要 原文：Brendan Gregg’s Blog :《Golang bcc/BPF Function Tracing》，31 Jan 2017 引子：gdb、go execution tracer、GODEBUG、gctrace、schedtrace 一、gccgo Function Counting 二、Go gc Function Counting 三、Per-event invocati">
<meta name="keywords" content="DevOps,Linux,DTrace,Golang">
<meta property="og:type" content="article">
<meta property="og:title" content="动态追踪技术（四）：基于 Linux bcc&#x2F;BPF 实现 Go 程序动态追踪">
<meta property="og:url" content="http://riboseyim.github.com/2017/06/27/DTrace_bcc/index.html">
<meta property="og:site_name" content="Ribose Yim&#39;s Blog">
<meta property="og:description" content="摘要 原文：Brendan Gregg’s Blog :《Golang bcc/BPF Function Tracing》，31 Jan 2017 引子：gdb、go execution tracer、GODEBUG、gctrace、schedtrace 一、gccgo Function Counting 二、Go gc Function Counting 三、Per-event invocati">
<meta property="og:updated_time" content="2018-02-16T12:31:05.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="动态追踪技术（四）：基于 Linux bcc&#x2F;BPF 实现 Go 程序动态追踪">
<meta name="twitter:description" content="摘要 原文：Brendan Gregg’s Blog :《Golang bcc/BPF Function Tracing》，31 Jan 2017 引子：gdb、go execution tracer、GODEBUG、gctrace、schedtrace 一、gccgo Function Counting 二、Go gc Function Counting 三、Per-event invocati">
  
    <link rel="alternative" href="/atom.xml" title="Ribose Yim&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="http://o8m8ngokc.bkt.clouddn.com/icon_cangshu.jpg">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://o8m8ngokc.bkt.clouddn.com/icon_macbook.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">RiboseYim</a></h1>
		</hgroup>

		
		<p class="header-subtitle">愿交天下士，罄我怀中藏。</p>
		

		<form id="search-form" class="search">  <!-- 搜索框相关 -->
    <input type="text" id="st-search-input" name="q" results="0" class="st-default-search-input" maxlength="30" placeholder="Search..." autocomplete="off" autocorrect="off">
		</form>
		<div id="local-search-result"></div> <!-- 搜索结果区 -->
	  <p class='no-result'>No results found </p> 

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>

				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
						<li>Über</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/tags/DevOps">DevOps</a></li>
				        
							<li><a href="/tags/eBook">电子书</a></li>
				        
							<li><a href="/tags/Art">艺术评论</a></li>
				        
							<li><a href="/tags/Commander">讲武堂</a></li>
				        
							<li><a href="/tags/Economist">经济学人</a></li>
				        
							<li><a href="/tags/Policy-Law">Policy&amp;Law</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="twitter" target="_blank" href="https://twitter.com/RiboseYim" title="twitter">twitter</a>
					        
								<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/riboseyim" title="zhihu">zhihu</a>
					        
								<a class="github" target="_blank" href="https://github.com/riboseyim" title="github">github</a>
					        
								<a class="linkedin" target="_blank" href="http://www.linkedin.com/in/%E7%9D%BF-%E4%B8%A5-b39028110" title="linkedin">linkedin</a>
					        
						</div>
					</nav>
				</section>

				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Art/" style="font-size: 15.45px;">Art</a> <a href="/tags/Books/" style="font-size: 10px;">Books</a> <a href="/tags/Commander/" style="font-size: 12.73px;">Commander</a> <a href="/tags/Cyber-Security/" style="font-size: 15px;">Cyber-Security</a> <a href="/tags/DTrace/" style="font-size: 11.36px;">DTrace</a> <a href="/tags/DevOps/" style="font-size: 20px;">DevOps</a> <a href="/tags/Developer/" style="font-size: 19.09px;">Developer</a> <a href="/tags/Develper/" style="font-size: 10px;">Develper</a> <a href="/tags/Economist/" style="font-size: 17.73px;">Economist</a> <a href="/tags/Education/" style="font-size: 10px;">Education</a> <a href="/tags/Golang/" style="font-size: 13.64px;">Golang</a> <a href="/tags/Health/" style="font-size: 10.91px;">Health</a> <a href="/tags/History/" style="font-size: 17.27px;">History</a> <a href="/tags/Lincoln/" style="font-size: 10.45px;">Lincoln</a> <a href="/tags/Linux/" style="font-size: 18.18px;">Linux</a> <a href="/tags/Mac/" style="font-size: 11.82px;">Mac</a> <a href="/tags/Machine-Learning/" style="font-size: 15.91px;">Machine-Learning</a> <a href="/tags/Manager/" style="font-size: 16.82px;">Manager</a> <a href="/tags/Medical/" style="font-size: 13.64px;">Medical</a> <a href="/tags/Nodejs/" style="font-size: 10.91px;">Nodejs</a> <a href="/tags/OpenSource/" style="font-size: 15.91px;">OpenSource</a> <a href="/tags/PHT/" style="font-size: 10.91px;">PHT</a> <a href="/tags/Policy-Law/" style="font-size: 19.55px;">Policy&Law</a> <a href="/tags/Redology/" style="font-size: 10.91px;">Redology</a> <a href="/tags/SDN/" style="font-size: 13.18px;">SDN</a> <a href="/tags/SRE/" style="font-size: 15.91px;">SRE</a> <a href="/tags/Science/" style="font-size: 15px;">Science</a> <a href="/tags/Sport/" style="font-size: 11.36px;">Sport</a> <a href="/tags/eBook/" style="font-size: 14.09px;">eBook</a> <a href="/tags/工具癖/" style="font-size: 12.27px;">工具癖</a> <a href="/tags/我的自传/" style="font-size: 12.27px;">我的自传</a> <a href="/tags/摄影/" style="font-size: 11.36px;">摄影</a> <a href="/tags/数学与算法/" style="font-size: 15px;">数学与算法</a> <a href="/tags/数据可视化/" style="font-size: 14.55px;">数据可视化</a> <a href="/tags/数据库/" style="font-size: 10.45px;">数据库</a> <a href="/tags/最佳写作实践/" style="font-size: 12.73px;">最佳写作实践</a> <a href="/tags/最佳工程实践/" style="font-size: 16.36px;">最佳工程实践</a> <a href="/tags/架构师/" style="font-size: 18.64px;">架构师</a> <a href="/tags/科技史/" style="font-size: 10.45px;">科技史</a> <a href="/tags/移动互联网/" style="font-size: 10px;">移动互联网</a> <a href="/tags/网络协议/" style="font-size: 16.82px;">网络协议</a> <a href="/tags/讲武堂/" style="font-size: 10.45px;">讲武堂</a>
					</div>
				</section>
				

				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.jianshu.com/c/f2ea0605db4b">专题-经济学人翻译社</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://www.gitbook.com/book/riboseyim/linux-perf-master/details">电子书《Linux Perf Master》</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.jianshu.com/c/9a817d8a67ea">简书专题-系统运维专家</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.jianshu.com/c/0886ffd76168">简书专题-网络与信息安全</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.jianshu.com/c/9ae32222e422">简书专题-操作系统与动态追踪技术</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.jianshu.com/c/8d40a3a05825">简书专题-数据可视化</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://riboseyim.github.io/2017/11/16/QuickStart/">快捷目录</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://riboseyim.github.io/2017/05/26/Catalog/">总目录</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">Engineer &amp; Writer</div>
				</section>
				
			</div>
		</div>
	</header>
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">RiboseYim</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="http://o8m8ngokc.bkt.clouddn.com/icon_macbook.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">RiboseYim</h1>
			</hgroup>
			
			<p class="header-subtitle">愿交天下士，罄我怀中藏。</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags/DevOps">DevOps</a></li>
		        
					<li><a href="/tags/eBook">电子书</a></li>
		        
					<li><a href="/tags/Art">艺术评论</a></li>
		        
					<li><a href="/tags/Commander">讲武堂</a></li>
		        
					<li><a href="/tags/Economist">经济学人</a></li>
		        
					<li><a href="/tags/Policy-Law">Policy&amp;Law</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="twitter" target="_blank" href="https://twitter.com/RiboseYim" title="twitter">twitter</a>
			        
						<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/riboseyim" title="zhihu">zhihu</a>
			        
						<a class="github" target="_blank" href="https://github.com/riboseyim" title="github">github</a>
			        
						<a class="linkedin" target="_blank" href="http://www.linkedin.com/in/%E7%9D%BF-%E4%B8%A5-b39028110" title="linkedin">linkedin</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-DTrace_bcc" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/06/27/DTrace_bcc/" class="article-date">
  	<time datetime="2017-06-27T06:47:15.000Z" itemprop="datePublished">2017-06-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      动态追踪技术（四）：基于 Linux bcc/BPF 实现 Go 程序动态追踪
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DTrace/">DTrace</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DevOps/">DevOps</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Golang/">Golang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li></ul>
	</div>

        


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><ul>
<li>原文：<a href="http://www.brendangregg.com/blog/2017-01-31/golang-bcc-bpf-function-tracing.html" target="_blank" rel="external">Brendan Gregg’s Blog :《Golang bcc/BPF Function Tracing》，31 Jan 2017</a></li>
<li>引子：gdb、go execution tracer、GODEBUG、gctrace、schedtrace</li>
<li>一、gccgo Function Counting</li>
<li>二、Go gc Function Counting</li>
<li>三、Per-event invocations of a function</li>
<li>四、Interface Arguments</li>
<li>五、Function Latency</li>
<li>六、总结</li>
<li>七、Tips：构建 LLVM 和 Clang 开发工具库</li>
</ul>
<a id="more"></a>
<p>在这篇文章中，我将迅速调研一种跟踪的 Go 程序的新方法：基于 Linux 4.x eBPF 实现动态跟踪。如果你去搜索 Go 和 BPF，你会发现使用 BPF 接口的 Go 语言接口（例如，gobpf）。这不是我所探索的东西：我将使用 BPF 工具实现 Go 应用程序的性能分析和调试。</p>
<p>目前已经有多种调试和追踪 Go 程序的方法，包括但不限于：</p>
<ul>
<li><a href="https://golang.org/doc/gdb" target="_blank" rel="external">gdb</a></li>
<li><p><a href="https://golang.org/pkg/runtime/trace/" target="_blank" rel="external">go execution tracer</a> ：用于高层异常和阻塞事件</p>
<blockquote>
<p>Go execution tracer. (import “runtime/trace”)<br>The tracer captures a wide range of execution events like goroutine creation/blocking/unblocking, syscall enter/exit/block, GC-related events, changes of heap size, processor start/stop, etc and writes them to an io.Writer in a compact form. A precise nanosecond-precision timestamp and a stack trace is captured for most events. A trace can be analyzed later with ‘go tool trace’ command.</p>
</blockquote>
</li>
<li><p><strong>GODEBUG</strong> （一个跨平台的Go程序调试工具）、 <strong>gctrace</strong> 和 <strong>schedtrace</strong></p>
</li>
</ul>
<p>BPF 追踪以做很多事，但都有自己的优点和缺点，接下来将详细说明。首先我从一个简单的 Go 程序开始（ hello.go）</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">        fmt.Println(<span class="string">"Hello, BPF!"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="一、gccgo-Function-Counting"><a href="#一、gccgo-Function-Counting" class="headerlink" title="一、gccgo Function Counting"></a>一、gccgo Function Counting</h2><p>我开始会使用 gccgo 编译，然后使用 Go gc 编译器 。（区别：gccgo 可以生成优化后的二进制文件，但是基于老版本的 Go。）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">## 编译</span></div><div class="line">$ gccgo -o hello hello.go</div><div class="line">$ ./hello</div><div class="line">Hello, BPF!</div></pre></td></tr></table></figure>
<p>现在我将使用 <a href="https://github.com/iovisor/bcc" target="_blank" rel="external">bcc</a> 工具的 <strong>funccount</strong> 来动态跟踪和计数所有以 “fmt.” 开头的 Go 库函数调用，在另一个终端重新运行 Hello 程序效果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># funccount 'go:fmt.*'</span></div><div class="line">Tracing 160 <span class="built_in">functions</span> <span class="keyword">for</span> <span class="string">"go:fmt.*"</span>... Hit Ctrl-C to end.</div><div class="line">^C</div><div class="line">FUNC                                    COUNT</div><div class="line">fmt..import                                 1</div><div class="line">fmt.padString.pN7_fmt.fmt                   1</div><div class="line">fmt.fmt_s.pN7_fmt.fmt                       1</div><div class="line">fmt.WriteString.pN10_fmt.buffer             1</div><div class="line">fmt.free.pN6_fmt.pp                         1</div><div class="line">fmt.fmtString.pN6_fmt.pp                    1</div><div class="line">fmt.doPrint.pN6_fmt.pp                      1</div><div class="line">fmt.init.pN7_fmt.fmt                        1</div><div class="line">fmt.printArg.pN6_fmt.pp                     1</div><div class="line">fmt.WriteByte.pN10_fmt.buffer               1</div><div class="line">fmt.Println                                 1</div><div class="line">fmt.truncate.pN7_fmt.fmt                    1</div><div class="line">fmt.Fprintln                                1</div><div class="line">fmt.<span class="variable">$nested1</span>                                1</div><div class="line">fmt.newPrinter                              1</div><div class="line">fmt.clearflags.pN7_fmt.fmt                  2</div><div class="line">Detaching...</div></pre></td></tr></table></figure>
<p>Neat! 输出结果中包含该程序的 <strong>fmt.Println()</strong> 函数调用。</p>
<p>我不需要进入任何特殊的模式才能实现这个效果，对于一个已经在运行的 Go 应用我可以直接开始测量而不需要重启进程。 <strong>So how does it even work?</strong> 这要归功于 <strong>uprobes</strong> ，Linux 3.5 新增的特性，详见<a href="http://www.brendangregg.com/blog/2015-06-28/linux-ftrace-uprobe.html" target="_blank" rel="external">Linux uprobes: User-Level Dynamic Tracing</a> 。</p>
<blockquote>
<p>It overwrites instructions with a soft interrupt to kernel instrumentation, and reverses the process when tracing has ended.</p>
</blockquote>
<p>gccgo 编译的输出提供一个标准的符号表用于函数查找。在这种情况下，我利用 libgo 当测量工具（假定“lib”在“go:”之前），作为 gccgo 发出的一个二进制动态链接库（libgo 包含 fmt 包）。uprobes 可以连接到已经运行的进程，或者像我现在一样作为一个二进制库，捕捉所有调用自己的进程。</p>
<p>为了提高效率，我在内核上下文中进行函数调用计数，只将计数发送到用户空间。例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">$ file hello</div><div class="line">hello: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.s</span>o<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=<span class="number">4d</span>c45f1eb023f44ddb32c15bbe0fb4f933e61815, not stripped</div><div class="line">$ ls -lh hello</div><div class="line">-rwxr-xr-x <span class="number">1</span> bgregg root <span class="number">29</span>K Jan <span class="number">12</span> <span class="number">21</span>:<span class="number">18</span> hello</div><div class="line">$ ldd hello</div><div class="line">    linux-vdso.so<span class="number">.1</span> =&gt;  (<span class="number">0x00007ff</span>c4cb1a000)</div><div class="line">    libgo.so<span class="number">.9</span> =&gt; /usr/lib/x86_64-linux-gnu/libgo.so<span class="number">.9</span> (<span class="number">0x00007f25f</span>2407000)</div><div class="line">    libgcc_s.so<span class="number">.1</span> =&gt; /lib/x86_64-linux-gnu/libgcc_s.so<span class="number">.1</span> (<span class="number">0x00007f25f21f</span>1000)</div><div class="line">    libc.so<span class="number">.6</span> =&gt; /lib/x86_64-linux-gnu/libc.so<span class="number">.6</span> (<span class="number">0x00007f25f</span>1e27000)</div><div class="line">    /lib64/ld-linux-x86<span class="number">-64.s</span>o<span class="number">.2</span> (<span class="number">0x0000560b44960000</span>)</div><div class="line">    libpthread.so<span class="number">.0</span> =&gt; /lib/x86_64-linux-gnu/libpthread.so<span class="number">.0</span> (<span class="number">0x00007f25f</span>1c0a000)</div><div class="line">    libm.so<span class="number">.6</span> =&gt; /lib/x86_64-linux-gnu/libm.so<span class="number">.6</span> (<span class="number">0x00007f25f</span>1901000)</div><div class="line">$ objdump -tT /usr/lib/x86_64-linux-gnu/libgo.so<span class="number">.9</span> | grep fmt.Println</div><div class="line"><span class="number">0000000001221070</span> g     O .data.rel.ro   <span class="number">0000000000000008</span>              fmt.Println$descriptor</div><div class="line"><span class="number">0000000000978090</span> g     F .text  <span class="number">0000000000000075</span>              fmt.Println</div><div class="line"><span class="number">0000000001221070</span> g    DO .data.rel.ro   <span class="number">0000000000000008</span>  Base        fmt.Println$descriptor</div><div class="line"><span class="number">0000000000978090</span> g    DF .text  <span class="number">0000000000000075</span>  Base        fmt.Println</div></pre></td></tr></table></figure>
<p>这些内容看起来非常像一个编译过的 C 语言二进制程序，因此可以使用包括 bcc/BPF在内的许多现有的调试工具和追踪器观测。相对于测量即时编译的运行时要简单得多（例如 Java 和 Node.js）。到目前为止，这个例子唯一的麻烦事函数名称中可能包含非标准的字符，例如“.”。</p>
<p><strong>funccount</strong> also has options like -p to match a PID, and -i to emit output every interval. It currently can only handle up to 1000 probes at a time, so “fmt.*“ was ok, but matching everything in libgo:</p>
<p><strong>funccount</strong> 提供 -p 选项来匹配进程号（PID），-i 选项来控制输出频率。它目前能够同时处理 1000 个探测点，匹配 “fmt.*” 时运行正常，但是匹配 libgo 的所有函数就出现异常。诸如此类的问题在 bcc/BPF 中还有不少，我们需要寻找其它的方法来处理。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># funccount 'go:*'</span></div><div class="line">maximum of 1000 probes allowed, attempted 21178</div></pre></td></tr></table></figure>
<h2 id="二、Go-gc-Function-Counting"><a href="#二、Go-gc-Function-Counting" class="headerlink" title="二、Go gc Function Counting"></a>二、Go gc Function Counting</h2><p>使用 Go 语言的 gc 编译器实现 fmt 函数调用计数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ go build hello.go</div><div class="line">$ ./hello</div><div class="line">Hello, BPF!</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># funccount '/home/bgregg/hello:fmt.*'</span></div><div class="line">Tracing 78 <span class="built_in">functions</span> <span class="keyword">for</span> <span class="string">"/home/bgregg/hello:fmt.*"</span>... Hit Ctrl-C to end.</div><div class="line">^C</div><div class="line">FUNC                                    COUNT</div><div class="line">fmt.init.1                                  1</div><div class="line">fmt.(*fmt).padString                        1</div><div class="line">fmt.(*fmt).truncate                         1</div><div class="line">fmt.(*fmt).fmt_s                            1</div><div class="line">fmt.newPrinter                              1</div><div class="line">fmt.(*pp).free                              1</div><div class="line">fmt.Fprintln                                1</div><div class="line">fmt.Println                                 1</div><div class="line">fmt.(*pp).fmtString                         1</div><div class="line">fmt.(*pp).printArg                          1</div><div class="line">fmt.(*pp).doPrint                           1</div><div class="line">fmt.glob.func1                              1</div><div class="line">fmt.init                                    1</div><div class="line">Detaching...</div></pre></td></tr></table></figure>
<p>你依然能够追踪到 fmt.Println() ，这个二进制程序与 libgo 有所不同：包含该函数的是一个 2M 的静态库（而非动态库的 29K ）。另一个区别就是函数名称包含更多特殊字符，例如 “*“, “(“,等等，我怀疑如果不能修正处理的haul将影响其它调试器（例如 bcc 追踪器）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ file hello</div><div class="line">hello: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, not stripped</div><div class="line">$ ls -lh hello</div><div class="line">-rwxr-xr-x 1 bgregg root 2.2M Jan 12 05:16 hello</div><div class="line">$ ldd hello</div><div class="line">    not a dynamic executable</div><div class="line">$ objdump -t hello | grep fmt.Println</div><div class="line">000000000045a680 g     F .text  00000000000000e0 fmt.Println</div></pre></td></tr></table></figure>
<h2 id="三、Per-event-invocations-of-a-function"><a href="#三、Per-event-invocations-of-a-function" class="headerlink" title="三、Per-event invocations of a function"></a>三、Per-event invocations of a function</h2><h4 id="3-1-gccgo-Function-Tracing"><a href="#3-1-gccgo-Function-Tracing" class="headerlink" title="3.1 gccgo Function Tracing"></a>3.1 gccgo Function Tracing</h4><p>现在我将尝试使用 <a href="https://www.linkedin.com/in/sashag/?ppe=1" target="_blank" rel="external">Sasha Goldshtein</a> 的追踪工具，也是基于 <a href="https://github.com/iovisor/bcc" target="_blank" rel="external">bcc</a>，用来查看每一个函数调用事件。我将回到 gccgo，使用一个非常简单的示例程序（ from the <a href="https://tour.golang.org/basics/4" target="_blank" rel="external">go tour</a> ），functions.go:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(x <span class="keyword">int</span>, y <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> x + y</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    fmt.Println(add(<span class="number">42</span>, <span class="number">13</span>))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>追踪 add() 函数。所有参数都输出在右侧，trace 还有其他选项（帮助 -h ），例如输出时间戳和堆栈。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">\<span class="comment"># trace '/home/bgregg/functions:main.add'</span></div><div class="line">PID    TID    COMM         FUNC             </div><div class="line">14424  14424  <span class="built_in">functions</span>    main.add  </div><div class="line"></div><div class="line"><span class="comment">#... and with both its arguments:</span></div><div class="line"></div><div class="line">\<span class="comment"># trace '/home/bgregg/functions:main.add "%d %d" arg1, arg2'</span></div><div class="line">PID    TID    COMM         FUNC             -</div><div class="line">14390  14390  <span class="built_in">functions</span>    main.add         42 13</div></pre></td></tr></table></figure>
<h4 id="3-2-Go-gc-Function-Tracing"><a href="#3-2-Go-gc-Function-Tracing" class="headerlink" title="3.2 Go gc Function Tracing"></a>3.2 Go gc Function Tracing</h4><p>同样的程序，如果使用 go build 就没有 main.add() ?  禁用代码嵌入（ Disabling inlining）即可。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ <span class="keyword">go</span> build functions.<span class="keyword">go</span></div><div class="line"></div><div class="line"># trace <span class="string">'/home/bgregg/functions:main.add "%d %d" arg1, arg2'</span></div><div class="line">could not determine address of symbol main.add</div><div class="line"></div><div class="line">$ objdump -t functions | grep main.add</div><div class="line">$</div></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ <span class="keyword">go</span> build -gcflags <span class="string">'-l'</span> functions.<span class="keyword">go</span></div><div class="line">$ objdump -t functions | grep main.add</div><div class="line"><span class="number">0000000000401000</span> g     F .text  <span class="number">0000000000000020</span> main.add</div><div class="line"></div><div class="line"># trace <span class="string">'/home/bgregg/functions:main.add "%d %d" arg1, arg2'</span></div><div class="line">PID    TID    COMM         FUNC             -</div><div class="line"><span class="number">16061</span>  <span class="number">16061</span>  functions    main.add         <span class="number">536912504</span> <span class="number">16</span></div></pre></td></tr></table></figure>
<p><strong>That’s wrong.</strong> 参数应该是 42 和 13 而不是 536912504 和 16。<br>使用 gdb 查看结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">$ gdb ./<span class="built_in">functions</span></div><div class="line">[...]</div><div class="line">warning: File <span class="string">"/usr/share/go-1.6/src/runtime/runtime-gdb.py"</span> auto-loading has been declined</div><div class="line"> by your <span class="string">'auto-load safe-path'</span> <span class="built_in">set</span> to <span class="string">"<span class="variable">$debugdir</span>:<span class="variable">$datadir</span>/auto-load"</span>.</div><div class="line">[...]</div><div class="line">(gdb) b main.add</div><div class="line">Breakpoint 1 at 0x401000: file /home/bgregg/functions.go, line 6.</div><div class="line">(gdb) r</div><div class="line">Starting program: /home/bgregg/<span class="built_in">functions</span></div><div class="line">[New LWP 16082]</div><div class="line">[New LWP 16083]</div><div class="line">[New LWP 16084]</div><div class="line">Thread 1 <span class="string">"functions"</span> hit Breakpoint 1, main.add (x=42, y=13, ~r2=4300314240) at</div><div class="line"> /home/bgregg/functions.go:6</div><div class="line">6           <span class="built_in">return</span> x + y</div><div class="line">(gdb) i r</div><div class="line">rax            0xc820000180 859530330496</div><div class="line">rbx            0x584ea0 5787296</div><div class="line">rcx            0xc820000180 859530330496</div><div class="line">rdx            0xc82005a048 859530698824</div><div class="line">rsi            0x10 16</div><div class="line">rdi            0xc82000a2a0 859530371744</div><div class="line">rbp            0x0  0x0</div><div class="line">rsp            0xc82003fed0 0xc82003fed0</div><div class="line">r8             0x41 65</div><div class="line">r9             0x41 65</div><div class="line">r10            0x4d8ba0 5082016</div><div class="line">r11            0x0  0</div><div class="line">r12            0x10 16</div><div class="line">r13            0x52a3c4 5415876</div><div class="line">r14            0xa  10</div><div class="line">r15            0x8  8</div><div class="line">rip            0x401000 0x401000</div><div class="line">eflags         0x206    [ PF IF ]</div><div class="line">cs             0xe033   57395</div><div class="line">ss             0xe02b   57387</div><div class="line">ds             0x0  0</div><div class="line">es             0x0  0</div><div class="line">fs             0x0  0</div><div class="line">gs             0x0  0</div></pre></td></tr></table></figure>
<p>启动信息中包含一个关于 runtime-gdb.py 的警告，它非常有用：如果需要进一步深入挖掘 Go 上下文，我希望能够修复并找出告警原因。即使没有该信息，gdb 依然可以输出参数变量的值是 “x=42, y=13”。我也将它们从寄存器导出与 x86_64 ABI（Application Binary Interface，应用程序二进制接口）对比，which is how bcc’s trace reads them. From the syscall(2) man page:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">       arch/ABI      arg1  arg2  arg3  arg4  arg5  arg6  arg7  Notes</div><div class="line">       ──────────────────────────────────────────────────────────────────</div><div class="line">[...]</div><div class="line">       x86_64        rdi   rsi   rdx   r10   r8    r9    -</div></pre></td></tr></table></figure>
<blockquote>
<p>The reason is that Go’s gc compiler is not following the standard AMD64 ABI function calling convention, which causes problems with this and other debuggers.</p>
</blockquote>
<p>42 和 13 没有出现在 rdi , rsi 或者其它任何一个寄存器。原因是 Go 的 gc 编译器不遵循标准的 AMD64 ABI 函数调用约定，其它调试器也会存在这个问题。这很烦人。我猜 Go 语言的返回值使用的是另外一种 ABI，因为它可以返回多个值，所以即使入口参数是标准的，我们仍然会遇到差异。我浏览了指南（Quick Guide to Go’s Assembler and the Plan 9 assembly manual），看起来函数在堆栈上传递。这些是我们的 42 和 13：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(gdb) x/<span class="number">3</span>dg $rsp</div><div class="line"><span class="number">0xc82003fed0</span>:   <span class="number">4198477</span> <span class="number">42</span></div><div class="line"><span class="number">0xc82003fee0</span>:   <span class="number">13</span></div></pre></td></tr></table></figure>
<p>BPF can dig these out too. As a proof of concept, I just hacked in a couple of new aliases, “go1” and “go2” for those entry arguments:</p>
<p>BPF 也可以挖掘这些信息。为了验证这一个概念，我为入口参数声明一对新的别名“go1”和“go2” 。希望您阅读本文的时候，我（或者其他人）已经将它加入到 bcc 追踪工具中，最好是 “goarg1”, “goarg2”, 等等。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># trace '/home/bgregg/functions:main.add "%d %d" go1, go2'</span></div><div class="line">PID    TID    COMM         FUNC             -</div><div class="line">17555  17555  <span class="built_in">functions</span>    main.add         42 13</div></pre></td></tr></table></figure>
<h2 id="四、Interface-Arguments"><a href="#四、Interface-Arguments" class="headerlink" title="四、Interface Arguments"></a>四、Interface Arguments</h2><p>你可以写一个自定义的 bcc/BPF 程序来挖掘，为了处理接口参数我们可以给 bcc 的跟踪程序添加多个别名。输入参数是接口的示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Println</span><span class="params">(a ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> Fprintln(os.Stdout, a...)</div></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">$ gdb ./hello</div><div class="line">[...]</div><div class="line">(gdb) b fmt.Println</div><div class="line">Breakpoint <span class="number">1</span> at <span class="number">0x401c50</span></div><div class="line">(gdb) r</div><div class="line">Starting program: /home/bgregg/hello</div><div class="line">[Thread debugging using libthread_db enabled]</div><div class="line">Using host libthread_db library <span class="string">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span>.</div><div class="line">[New Thread <span class="number">0x7ffff</span>449c700 (LWP <span class="number">16836</span>)]</div><div class="line">[New Thread <span class="number">0x7ffff</span>3098700 (LWP <span class="number">16837</span>)]</div><div class="line">[Switching to Thread <span class="number">0x7ffff</span>3098700 (LWP <span class="number">16837</span>)]</div><div class="line">Thread <span class="number">3</span> <span class="string">"hello"</span> hit Breakpoint <span class="number">1</span>, fmt.Println (a=...) at ../../../src/libgo/<span class="keyword">go</span>/fmt/<span class="built_in">print</span>.<span class="keyword">go</span>:<span class="number">263</span></div><div class="line"><span class="number">263</span> ../../../src/libgo/<span class="keyword">go</span>/fmt/<span class="built_in">print</span>.<span class="keyword">go</span>: No such file or directory.</div><div class="line">(gdb) p a</div><div class="line">$<span class="number">1</span> = &#123;__values = <span class="number">0xc208000240</span>, __count = <span class="number">1</span>, __capacity = <span class="number">1</span>&#125;</div><div class="line">(gdb) p a.__values</div><div class="line">$<span class="number">18</span> = (<span class="keyword">struct</span> &#123;...&#125; *) <span class="number">0xc208000240</span></div><div class="line">(gdb) p a.__values[<span class="number">0</span>]</div><div class="line">$<span class="number">20</span> = &#123;__type_descriptor = <span class="number">0x4037c0</span> &lt;__go_tdn_string&gt;, __object = <span class="number">0xc208000210</span>&#125;</div><div class="line">(gdb) x/s *<span class="number">0xc208000210</span></div><div class="line"><span class="number">0x403483</span>:   <span class="string">"Hello, BPF!"</span></div></pre></td></tr></table></figure>
<h2 id="五、Function-Latency"><a href="#五、Function-Latency" class="headerlink" title="五、Function Latency"></a>五、Function Latency</h2><ul>
<li>示例：循环调用 fmt.Println() 函数的时延直方图（纳秒）</li>
</ul>
<p><strong>WARNING:</strong> Go 函数调用过程中，如果从一个进程（goroutine）切换到另外一个系统进程，<strong>funclatency</strong> 无法匹配入口-返回。这种场景需要一个新的工具 —— <strong>gofunclatency</strong> ，它基于 Go 内建的 GOID 替代系统的 TID 追踪时延，在某些情况下， <strong>uretprobes</strong> 修改 Go 程序可能出现崩溃的问题，因此在调试之前需要准备周全的计划。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"># funclatency <span class="string">'go:fmt.Println'</span></div><div class="line">Tracing <span class="number">1</span> functions <span class="keyword">for</span> <span class="string">"go:fmt.Println"</span>... Hit Ctrl-C to end.</div><div class="line">^C</div><div class="line"></div><div class="line">Function = fmt.Println [<span class="number">3041</span>]</div><div class="line">     nsecs               : count     distribution</div><div class="line">         <span class="number">0</span> -&gt; <span class="number">1</span>          : <span class="number">0</span>        |                                        |</div><div class="line">         <span class="number">2</span> -&gt; <span class="number">3</span>          : <span class="number">0</span>        |                                        |</div><div class="line">         <span class="number">4</span> -&gt; <span class="number">7</span>          : <span class="number">0</span>        |                                        |</div><div class="line">         <span class="number">8</span> -&gt; <span class="number">15</span>         : <span class="number">0</span>        |                                        |</div><div class="line">        <span class="number">16</span> -&gt; <span class="number">31</span>         : <span class="number">0</span>        |                                        |</div><div class="line">        <span class="number">32</span> -&gt; <span class="number">63</span>         : <span class="number">0</span>        |                                        |</div><div class="line">        <span class="number">64</span> -&gt; <span class="number">127</span>        : <span class="number">0</span>        |                                        |</div><div class="line">       <span class="number">128</span> -&gt; <span class="number">255</span>        : <span class="number">0</span>        |                                        |</div><div class="line">       <span class="number">256</span> -&gt; <span class="number">511</span>        : <span class="number">0</span>        |                                        |</div><div class="line">       <span class="number">512</span> -&gt; <span class="number">1023</span>       : <span class="number">0</span>        |                                        |</div><div class="line">      <span class="number">1024</span> -&gt; <span class="number">2047</span>       : <span class="number">0</span>        |                                        |</div><div class="line">      <span class="number">2048</span> -&gt; <span class="number">4095</span>       : <span class="number">0</span>        |                                        |</div><div class="line">      <span class="number">4096</span> -&gt; <span class="number">8191</span>       : <span class="number">0</span>        |                                        |</div><div class="line">      <span class="number">8192</span> -&gt; <span class="number">16383</span>      : <span class="number">27</span>       |****************************************|</div><div class="line">     <span class="number">16384</span> -&gt; <span class="number">32767</span>      : <span class="number">3</span>        |****                                    |</div><div class="line">Detaching...</div></pre></td></tr></table></figure>
<h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><p>原作者总结很简洁，不再赘述。</p>
<blockquote>
<p>I took a quick look at Golang with dynamic tracing and Linux enhanced BPF, via bcc’s funccount and trace tools, with some successes and some challenges. Counting function calls works already. Tracing function arguments when compiled with gccgo also works, whereas Go’s gc compiler doesn’t follow the standard ABI calling convention, so the tools need to be updated to support this. As a proof of concept I modified the bcc trace tool to show it could be done, but that feature needs to be coded properly and integrated. Processing interface objects will also be a challenge, and multi-return values, again, areas where we can improve the tools to make this easier, as well as add macros to C for writing other custom Go observability tools as well.</p>
</blockquote>
<h2 id="七、Tips"><a href="#七、Tips" class="headerlink" title="七、Tips"></a>七、Tips</h2><h4 id="6-1-安装和编译-BCC"><a href="#6-1-安装和编译-BCC" class="headerlink" title="6.1 安装和编译 BCC"></a>6.1 安装和编译 BCC</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/iovisor/bcc.git</div><div class="line">mkdir bcc/build; cd bcc/build</div><div class="line">cmake -DCMAKE_INSTALL_PREFIX=/usr \</div><div class="line">      -DLUAJIT_INCLUDE_DIR=`pkg-config --variable=includedir luajit` \ # for lua support</div><div class="line">      ..</div><div class="line">make</div><div class="line">sudo make install</div><div class="line">cmake -DPYTHON_CMD=python3 .. # build python3 binding</div><div class="line">pushd src/python/</div><div class="line">make</div><div class="line">sudo make install</div><div class="line">popd</div></pre></td></tr></table></figure>
<h4 id="6-2-构建-LLVM-和-Clang-开发工具库"><a href="#6-2-构建-LLVM-和-Clang-开发工具库" class="headerlink" title="6.2 构建 LLVM 和 Clang 开发工具库"></a>6.2 构建 LLVM 和 Clang 开发工具库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">yum install gcc</div><div class="line">yum install gcc-g++</div><div class="line"></div><div class="line">wget https://cmake.org/files/v3.9/cmake-3.9.0-rc4.tar.gz</div><div class="line">tar -xvf cmake-3.9.0-rc4.tar.gz</div><div class="line"><span class="built_in">cd</span> cmake-3.9.0</div><div class="line">./bootstrap  </div><div class="line">gmake</div><div class="line">gmake install</div><div class="line"><span class="built_in">export</span> CMAKE_ROOT=/usr/<span class="built_in">local</span>/share/cmake-3.9.0</div><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$CMAKE_ROOT</span></div><div class="line"></div><div class="line">git <span class="built_in">clone</span> http://llvm.org/git/llvm.git</div><div class="line"><span class="built_in">cd</span> llvm/tools;</div><div class="line">git <span class="built_in">clone</span> http://llvm.org/git/clang.git</div><div class="line"><span class="built_in">cd</span> ..; mkdir -p build/install; <span class="built_in">cd</span> build</div><div class="line">cmake -G <span class="string">"Unix Makefiles"</span> -DLLVM_TARGETS_TO_BUILD=<span class="string">"BPF;X86"</span> -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=<span class="variable">$PWD</span>/install ..</div><div class="line">make</div><div class="line">make install</div><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$PWD</span>/install/bin:<span class="variable">$PATH</span></div></pre></td></tr></table></figure>
<h4 id="6-3-LLVM-与-Clang"><a href="#6-3-LLVM-与-Clang" class="headerlink" title="6.3 LLVM 与 Clang"></a>6.3 LLVM 与 Clang</h4><p>LLVM （Low Level Virtual Machine）是一种编译器基础设施，以C++写成。起源于2000年伊利诺伊大学厄巴纳-香槟分校维克拉姆·艾夫（Vikram Adve）与克里斯·拉特纳（Chris Lattner）的研究，他们想要为所有静态及动态语言创造出动态的编译技术。2005年，Apple直接雇用了克里斯·拉特纳及他的团队，为了苹果电脑开发应用程序，期间克里斯·拉特纳设计发明了 Swift 语言，LLVM 成为 Mac OS X 及 iOS 开发工具的一部分。LLVM 的范围早已经不局限于创建一个虚拟机，成为了众多编译工具及低级工具技术的统称，适用于LLVM下的所有项目，包含LLVM中介码（LLVM IR）、LLVM除错工具、LLVM C++标准库等。</p>
<p>目前 LLVM 已支持包括ActionScript、Ada、D语言、Fortran、GLSL、Haskell、Java字节码、Objective-C、Swift、Python、Ruby、Rust、Scala1以及C#等语言。</p>
<p>Clang 是LLVM编译器工具集的前端（front-end），目的是输出代码对应的抽象语法树（Abstract Syntax Tree, AST），并将代码编译成LLVM Bitcode。接着在后端（back-end）使用 LLVM 编译成平台相关的机器语言 。Clang支持C、C++、Objective C。它的目标是提供一个 GCC 的替代品。作者是克里斯·拉特纳（Chris Lattner），在苹果公司的赞助支持下进行开发。Clang项目包括Clang前端和Clang静态分析器等。</p>
<h4 id="6-4-ABI"><a href="#6-4-ABI" class="headerlink" title="6.4 ABI"></a>6.4 ABI</h4><p>应用二进制接口（Application Binary Interface， ABI）描述了应用程序和操作系统之间或其他应用程序的低级接口。ABI涵盖了各种细节，如：</p>
<ul>
<li>数据类型的大小、布局;</li>
<li>调用约定（控制着函数的参数如何传送以及如何接受返回值），例如，是所有的参数都通过栈传递，还是部分参数通过寄存器传递；哪个寄存器用于哪个函数参数；通过栈传递的第一个函数参数是最先push到栈上还是最后；</li>
<li><p>目标文件的二进制格式、程序库等等。</p>
</li>
<li><p>ABI vs API<br>应用程序接口 (API)定义了源代码和库之间的接口，因此同样的代码可以在支持这个API的任何系统中编译，然而ABI允许编译好的目标代码在使用兼容 ABI 的系统中无需改动就能运行。</p>
</li>
</ul>
<h2 id="扩展阅读：动态追踪技术"><a href="#扩展阅读：动态追踪技术" class="headerlink" title="扩展阅读：动态追踪技术"></a>扩展阅读：动态追踪技术</h2><ul>
<li><a href="https://riboseyim.github.io/2017/05/29/Linux-Works/" target="_blank" rel="external">操作系统原理 | How Linux Works（一）：How the Linux Kernel Boots</a></li>
<li><a href="https://riboseyim.github.io/2017/05/29/Linux-Works/" target="_blank" rel="external">操作系统原理 | How Linux Works（二）：User Space &amp; RAM</a></li>
<li><a href="https://riboseyim.github.io/2017/12/11/Linux-Works-Memory/" target="_blank" rel="external">操作系统原理 | How Linux Works（三）：Memory</a></li>
<li><a href="https://riboseyim.github.io/2016/11/26/DTrace/" target="_blank" rel="external">动态追踪技术(一)：DTrace 导论</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MjM5MTY1MjQ3Nw==&amp;mid=2651939588&amp;idx=1&amp;sn=35f71c5f88d1edf23cb2efc812ab8e6c&amp;chksm=bd578c168a20050041c08618281691f0111f61c789097a69095933057618637fc54817815921#rd" target="_blank" rel="external">动态追踪技术(二)：strace+gdb 溯源 Nginx 内存溢出异常 </a></li>
<li><a href="https://riboseyim.github.io/2017/04/17/DTrace_FTrace/" target="_blank" rel="external">动态追踪技术(三)：Tracing Your Kernel Function!</a></li>
<li><a href="https://riboseyim.github.io/2017/06/27/DTrace_bcc/" target="_blank" rel="external">动态追踪技术(四)：基于 Linux bcc/BPF 实现 Go 程序动态追踪</a></li>
<li><a href="https://riboseyim.github.io/2018/02/16/DTrace-Linux/" target="_blank" rel="external">动态追踪技术(五)：Welcome DTrace for Linux</a></li>
</ul>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li><a href="http://www.brendangregg.com/blog/2016-10-04/linux-bcc-mysqld-qslower.html" target="_blank" rel="external">Linux MySQL Slow Query Tracing with bcc/BPF | Brendan Gregg’s Blog</a></li>
<li><a href="https://jvns.ca/blog/2017/06/28/notes-on-bpf---ebpf/" target="_blank" rel="external">Notes on BPF &amp; eBPF | Julia Evans</a></li>
<li><a href="http://blogs.microsoft.co.il/sasha/2016/03/31/probing-the-jvm-with-bpfbcc/" target="_blank" rel="external">Probing the JVM with BPF/BCC | Sasha</a></li>
<li><a href="https://www.slideshare.net/brendangregg/bpf-tracing-and-more" target="_blank" rel="external">BPF: Tracing and more | Brendan Gregg SlideShare </a></li>
</ul>

      

    </div>
    
  </div>
  
    <div class="article-entry" itemprop="articleBody">
      <p>
      更多精彩内容请扫码关注公众号，如需咨询服务请付费加入知识星球
      <br>
      读者交流 QQ 群：338272982 [并不承诺解答任何问题]
      <br>
      互联网古典用户欢迎 RSS RiboseYim's Blog：<a href="https://riboseyim.github.io" target="_blank" rel="external">https://riboseyim.github.io</a>
      </p>
      <p>
        <a href="http://o8m8ngokc.bkt.clouddn.com/ID_RiboseYim_201706.png" title="微信公众号@睿哥杂货铺" rel="fancy-group" class="fancy-ctn fancybox">
          <img src="http://o8m8ngokc.bkt.clouddn.com/quanzi-rui-small.png" title="睿哥读书会">
          <img src="http://o8m8ngokc.bkt.clouddn.com/ID_RiboseYim_201706.png" title="微信公众号@睿哥杂货铺">
        </a>
      </p>
    </div>
    
<nav id="article-nav">
  
    <a href="/2017/06/27/TeamWork-Knowledge-Sharing/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          The Road To Leader：构建知识共享型团队
        
      </div>
    </a>
  
  
    <a href="/2017/06/27/Technology-English/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">论工程师的自我修养：全英文技术学习实践</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		  <a href="https://creativecommons.org/licenses/by-nc-nd/4.0" target="_blank">Copyright 2016-2018 RiboseYim
      授权：保持署名-非商业性使用-禁止演绎| License BY-NC-ND 4.0 </a>
    </div>
      	<div class="footer-right">
      		<a href="https://riboseyim.github.io/2016/05/31/AboutMe/" target="_blank"> 联系作者 </a>
      	</div>
    </div>
  </div>
</footer>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1258500076'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1258500076%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: true
	}
</script>
<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>