<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>开源架构技术漫谈：基于Kafka构建事件溯源模式的微服务 | Ribose Yim&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="概要本文中我们将讨论如何借助 Kafka 实现分布式消息管理，使用事件溯源（Event Sourcing）模式实现原子化数据处理，使用CQRS模式（Command-Query Responsibility Segregation ）实现查询职责分离，使用消费者群组解决单点故障问题，理解分布式协调框架Zookeeper的运行机制。整个应用的代码实现使用Go语言描述。  第一部分 引子、环境准备、整体">
<meta name="keywords" content="OpenSource,DevOps,Developer,Golang,SRE">
<meta property="og:type" content="article">
<meta property="og:title" content="开源架构技术漫谈：基于Kafka构建事件溯源模式的微服务">
<meta property="og:url" content="http://riboseyim.github.com/2017/06/12/OpenSource-Kafka-Microservice/index.html">
<meta property="og:site_name" content="Ribose Yim&#39;s Blog">
<meta property="og:description" content="概要本文中我们将讨论如何借助 Kafka 实现分布式消息管理，使用事件溯源（Event Sourcing）模式实现原子化数据处理，使用CQRS模式（Command-Query Responsibility Segregation ）实现查询职责分离，使用消费者群组解决单点故障问题，理解分布式协调框架Zookeeper的运行机制。整个应用的代码实现使用Go语言描述。  第一部分 引子、环境准备、整体">
<meta property="og:image" content="http://omb2onfvy.bkt.clouddn.com/MicroService_Org.png">
<meta property="og:image" content="http://omb2onfvy.bkt.clouddn.com/MicroServices_Math_Demo.png">
<meta property="og:image" content="http://omb2onfvy.bkt.clouddn.com/MicroService_EventSourcing.png">
<meta property="og:image" content="http://omb2onfvy.bkt.clouddn.com/MicroService_EventSourcing_Classes.png">
<meta property="og:image" content="http://omb2onfvy.bkt.clouddn.com/MicroService_Kafka_Consumers.jpg">
<meta property="og:image" content="http://omb2onfvy.bkt.clouddn.com/MicroService_UseDocker.jpg">
<meta property="og:image" content="http://omb2onfvy.bkt.clouddn.com/MicroService_CloudTest.png">
<meta property="og:updated_time" content="2018-05-31T17:25:00.009Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="开源架构技术漫谈：基于Kafka构建事件溯源模式的微服务">
<meta name="twitter:description" content="概要本文中我们将讨论如何借助 Kafka 实现分布式消息管理，使用事件溯源（Event Sourcing）模式实现原子化数据处理，使用CQRS模式（Command-Query Responsibility Segregation ）实现查询职责分离，使用消费者群组解决单点故障问题，理解分布式协调框架Zookeeper的运行机制。整个应用的代码实现使用Go语言描述。  第一部分 引子、环境准备、整体">
<meta name="twitter:image" content="http://omb2onfvy.bkt.clouddn.com/MicroService_Org.png">
  
    <link rel="alternative" href="/atom.xml" title="Ribose Yim&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="http://o8m8ngokc.bkt.clouddn.com/icon_cangshu.jpg">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://o8m8ngokc.bkt.clouddn.com/icon_macbook.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">RiboseYim</a></h1>
		</hgroup>

		
		<p class="header-subtitle">愿交天下士，罄我怀中藏。</p>
		

		<form id="search-form" class="search">  <!-- 搜索框相关 -->
    <input type="text" id="st-search-input" name="q" results="0" class="st-default-search-input" maxlength="30" placeholder="Search..." autocomplete="off" autocorrect="off">
		</form>
		<div id="local-search-result"></div> <!-- 搜索结果区 -->
	  <p class='no-result'>No results found </p> 

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>

				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
						<li>Über</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/tags/DevOps">DevOps</a></li>
				        
							<li><a href="/tags/eBook">电子书</a></li>
				        
							<li><a href="/tags/Art">艺术评论</a></li>
				        
							<li><a href="/tags/Commander">讲武堂</a></li>
				        
							<li><a href="/tags/Economist">经济学人</a></li>
				        
							<li><a href="/tags/Policy-Law">Policy&amp;Law</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="twitter" target="_blank" href="https://twitter.com/RiboseYim" title="twitter">twitter</a>
					        
								<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/riboseyim" title="zhihu">zhihu</a>
					        
								<a class="github" target="_blank" href="https://github.com/riboseyim" title="github">github</a>
					        
								<a class="linkedin" target="_blank" href="http://www.linkedin.com/in/%E7%9D%BF-%E4%B8%A5-b39028110" title="linkedin">linkedin</a>
					        
						</div>
					</nav>
				</section>

				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Art/" style="font-size: 15.24px;">Art</a> <a href="/tags/Books/" style="font-size: 10px;">Books</a> <a href="/tags/Commander/" style="font-size: 12.38px;">Commander</a> <a href="/tags/Cyber-Security/" style="font-size: 14.29px;">Cyber-Security</a> <a href="/tags/DTrace/" style="font-size: 11.43px;">DTrace</a> <a href="/tags/DevOps/" style="font-size: 20px;">DevOps</a> <a href="/tags/Developer/" style="font-size: 19.05px;">Developer</a> <a href="/tags/Develper/" style="font-size: 10px;">Develper</a> <a href="/tags/Economist/" style="font-size: 17.62px;">Economist</a> <a href="/tags/Education/" style="font-size: 10px;">Education</a> <a href="/tags/Golang/" style="font-size: 13.33px;">Golang</a> <a href="/tags/Health/" style="font-size: 10.48px;">Health</a> <a href="/tags/History/" style="font-size: 17.14px;">History</a> <a href="/tags/Lincoln/" style="font-size: 10.48px;">Lincoln</a> <a href="/tags/Linux/" style="font-size: 18.1px;">Linux</a> <a href="/tags/Machine-Learning/" style="font-size: 15.71px;">Machine-Learning</a> <a href="/tags/Manager/" style="font-size: 16.67px;">Manager</a> <a href="/tags/Medical/" style="font-size: 13.33px;">Medical</a> <a href="/tags/Nodejs/" style="font-size: 10.95px;">Nodejs</a> <a href="/tags/OpenSource/" style="font-size: 15.24px;">OpenSource</a> <a href="/tags/PHT/" style="font-size: 10.95px;">PHT</a> <a href="/tags/Policy-Law/" style="font-size: 19.52px;">Policy&Law</a> <a href="/tags/Redology/" style="font-size: 10.95px;">Redology</a> <a href="/tags/SDN/" style="font-size: 12.86px;">SDN</a> <a href="/tags/SRE/" style="font-size: 15.71px;">SRE</a> <a href="/tags/Science/" style="font-size: 14.76px;">Science</a> <a href="/tags/Sport/" style="font-size: 11.43px;">Sport</a> <a href="/tags/eBook/" style="font-size: 13.81px;">eBook</a> <a href="/tags/工具癖/" style="font-size: 11.9px;">工具癖</a> <a href="/tags/我的自传/" style="font-size: 11.9px;">我的自传</a> <a href="/tags/摄影/" style="font-size: 11.43px;">摄影</a> <a href="/tags/数学与算法/" style="font-size: 14.76px;">数学与算法</a> <a href="/tags/数据可视化/" style="font-size: 14.29px;">数据可视化</a> <a href="/tags/数据库/" style="font-size: 10.48px;">数据库</a> <a href="/tags/最佳写作实践/" style="font-size: 12.38px;">最佳写作实践</a> <a href="/tags/最佳工程实践/" style="font-size: 16.67px;">最佳工程实践</a> <a href="/tags/架构师/" style="font-size: 18.57px;">架构师</a> <a href="/tags/科技史/" style="font-size: 10.48px;">科技史</a> <a href="/tags/移动互联网/" style="font-size: 10px;">移动互联网</a> <a href="/tags/网络协议/" style="font-size: 16.19px;">网络协议</a> <a href="/tags/讲武堂/" style="font-size: 10.48px;">讲武堂</a>
					</div>
				</section>
				

				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.jianshu.com/c/f2ea0605db4b">专题-经济学人翻译社</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://www.gitbook.com/book/riboseyim/linux-perf-master/details">电子书《Linux Perf Master》</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.jianshu.com/c/9a817d8a67ea">简书专题-系统运维专家</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.jianshu.com/c/0886ffd76168">简书专题-网络与信息安全</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.jianshu.com/c/9ae32222e422">简书专题-操作系统与动态追踪技术</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.jianshu.com/c/8d40a3a05825">简书专题-数据可视化</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://riboseyim.github.io/2017/11/16/QuickStart/">快捷目录</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://riboseyim.github.io/2017/05/26/Catalog/">总目录</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">Engineer &amp; Writer</div>
				</section>
				
			</div>
		</div>
	</header>
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">RiboseYim</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="http://o8m8ngokc.bkt.clouddn.com/icon_macbook.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">RiboseYim</h1>
			</hgroup>
			
			<p class="header-subtitle">愿交天下士，罄我怀中藏。</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags/DevOps">DevOps</a></li>
		        
					<li><a href="/tags/eBook">电子书</a></li>
		        
					<li><a href="/tags/Art">艺术评论</a></li>
		        
					<li><a href="/tags/Commander">讲武堂</a></li>
		        
					<li><a href="/tags/Economist">经济学人</a></li>
		        
					<li><a href="/tags/Policy-Law">Policy&amp;Law</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="twitter" target="_blank" href="https://twitter.com/RiboseYim" title="twitter">twitter</a>
			        
						<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/riboseyim" title="zhihu">zhihu</a>
			        
						<a class="github" target="_blank" href="https://github.com/riboseyim" title="github">github</a>
			        
						<a class="linkedin" target="_blank" href="http://www.linkedin.com/in/%E7%9D%BF-%E4%B8%A5-b39028110" title="linkedin">linkedin</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-OpenSource-Kafka-Microservice" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/06/12/OpenSource-Kafka-Microservice/" class="article-date">
  	<time datetime="2017-06-12T10:11:25.000Z" itemprop="datePublished">2017-06-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      开源架构技术漫谈：基于Kafka构建事件溯源模式的微服务
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DevOps/">DevOps</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Developer/">Developer</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Golang/">Golang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenSource/">OpenSource</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SRE/">SRE</a></li></ul>
	</div>

        


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>本文中我们将讨论如何借助 Kafka 实现分布式消息管理，使用事件溯源（Event Sourcing）模式实现原子化数据处理，使用CQRS模式（Command-Query Responsibility Segregation ）实现查询职责分离，使用消费者群组解决单点故障问题，理解分布式协调框架Zookeeper的运行机制。整个应用的代码实现使用Go语言描述。</p>
<ul>
<li>第一部分 引子、环境准备、整体设计及实现</li>
<li>第二部分 消息消费者及其集群化</li>
<li>第三部分 测试驱动开发、Docker部署和持续集成</li>
</ul>
<a id="more"></a>
<h1 id="第一部分-引子、环境准备、整体设计及实现"><a href="#第一部分-引子、环境准备、整体设计及实现" class="headerlink" title="第一部分 引子、环境准备、整体设计及实现"></a>第一部分 引子、环境准备、整体设计及实现</h1><h2 id="为什么需要微服务"><a href="#为什么需要微服务" class="headerlink" title="为什么需要微服务"></a>为什么需要微服务</h2><p>微服务本身并不算什么新概念，它要解决的问题在软件工程历史中早已经有人提出：解耦、扩展性、灵活性，解决“烂架构”膨胀后带来的复杂度问题。</p>
<h5 id="Conway’s-law（康威定律）"><a href="#Conway’s-law（康威定律）" class="headerlink" title="Conway’s law（康威定律）"></a>Conway’s law（康威定律）</h5><blockquote>
<p><strong>Any organization that designs a system (defined broadly) will produce a design whose structure is a copy of the organization’s communication structure.（任何组织在设计一套系统（广义概念上的系统）时，所交付的设计方案在结构上都与该组织的通信结构保持一致）<br>– Melvyn Conway, 1967</strong></p>
</blockquote>
<p><img src="http://omb2onfvy.bkt.clouddn.com/MicroService_Org.png" alt=""></p>
<blockquote>
<p>《人月神话》：Adding manpower to a late software project makes it later –Fred Brooks, (1975)</p>
</blockquote>
<p>为了赶进度加程序员就像用水去灭油锅里的火一样，原因在于：沟通成本 = n(n-1)/2，沟通成本随着项目或者组织的人员增加呈指数级增长。很多项目在经过一段时间的发展之后，都会有不少恐龙级代码，无人敢挑战。比如一个类的规模就多达数千行，核心方法近千行，大量重复代码，每次调整都以失败告终。庞大的系统规模导致团队新成员接手困难，项目组人员增加导致的代码冲突问题，系统复杂度的增加导致的不确定上线风险、引入新技术困难等。</p>
<p><img src="http://omb2onfvy.bkt.clouddn.com/MicroServices_Math_Demo.png" alt=""></p>
<p>微服务 (Microservices)是解决这些困难的众多方案之一。它本质上是一种软件架构风格，它是以专注于单一责任与功能的小型功能区块 (Small Building Blocks) 为基础，利用模组化的方式组合出复杂的大型应用程序，各功能区块使用与语言无关 (Language-Independent/Language agnostic) 的 API 集相互通讯。</p>
<h5 id="Event-Sourcing（事件溯源）"><a href="#Event-Sourcing（事件溯源）" class="headerlink" title="Event Sourcing（事件溯源）"></a>Event Sourcing（事件溯源）</h5><p>真正构建一个微服务是非常具有挑战性的。其中一个最重要的挑战就是原子化————如何处理分布式数据，如何设计服务的粒度。例如，常见的客户、工单场景，如果拆分成两个服务，查询都变成了一个难题：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">order</span> o, customer c</div><div class="line">  <span class="keyword">where</span> o.customer_id = c.id</div><div class="line">  <span class="keyword">and</span> o.gross_amount &gt; <span class="number">50000</span></div><div class="line">  <span class="keyword">and</span> o.status = <span class="string">'PAID'</span></div><div class="line">  <span class="keyword">and</span> c.country = <span class="string">'INDONESIA'</span>;</div></pre></td></tr></table></figure></p>
<p>在DDD领域（Domain-Driven Design，领域驱动设计）有一种架构风格被广泛应用，即CQRS （Command Query Responsibility Seperation，命令查询职责分离）。CQRS最核心的概念是Command、Event，“将数据(Data)看做是事实(Fact)。每个事实都是过去的痕迹，虽然这种过去可以遗忘，但却无法改变。” 这一思想直接发展了Event Source，即将这些事件的发生过程记录下来，使得我们可以追溯业务流程。CQRS对设计者的影响，是将领域逻辑，尤其是业务流程，皆看做是一种领域对象状态迁移的过程。这一点与REST将HTTP应用协议看做是应用状态迁移的引擎，有着异曲同工之妙。</p>
<p><img src="http://omb2onfvy.bkt.clouddn.com/MicroService_EventSourcing.png" alt=""></p>
<h2 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h2><h3 id="Kafka-in-a-Nutshell"><a href="#Kafka-in-a-Nutshell" class="headerlink" title="Kafka in a Nutshell"></a>Kafka in a Nutshell</h3><p>Apache Kafka是由Apache软件基金会开发的一个开源消息中间件项目，由Scala写成。Kafka最初是由LinkedIn开发，并于2011年初开源。2012年10月从Apache Incubator毕业。该项目的目标是为处理实时数据提供一个统一、高吞吐、低延迟的平台。Kafka使用Zookeeper作为其分布式协调框架，很好的将消息生产、消息存储、消息消费的过程结合在一起。同时借助Zookeeper，kafka能够生产者、消费者和broker在内的所以组件在无状态的情况下，建立起生产者和消费者的订阅关系，并实现生产者与消费者的负载均衡。</p>
<ul>
<li>Kafka Core Words<br>Broker:Kafka集群包含一个或多个服务器，这种服务器被称为broker<br>Topic:每条发布到Kafka集群的消息都有一个类别，这个类别被称为Topic。Topic相当于数据库中的Table，行数据以log的形式存储，非常类似Git中commit log。物理上不同Topic的消息分开存储，逻辑上一个Topic的消息虽然保存于一个或多个broker上但用户只需指定消息的Topic即可生产或消费数据而不必关心数据存于何处。<br>Partition:Parition是物理上的概念，每个Topic包含一个或多个Partition.<br>Producer:消息生产者，负责发布消息到Kafka broker<br>Consumer:消息消费者，向Kafka broker读取消息的客户端。<br>Consumer Group：每个Consumer属于一个特定的Consumer Group（可为每个Consumer指定group name，若不指定则属于默认的group）。</li>
</ul>
<h3 id="整体设计"><a href="#整体设计" class="headerlink" title="整体设计"></a>整体设计</h3><p>案例：假设一个银行账户系统。经过一段时间的经营发展，该行客户数量和交易规模都有了巨大的增长，系统内部变得异常复杂，每一个部分都变得沉重不堪。我们尝试对他的业务单元进行解耦，例如将余额计算逻辑从原有的核心系统拆分出来。根据银行账户业务特点，我们设计一个生产者——负责根据业务事件触发生成一个事件，所有事件基于Kafka存储，再设计一个消费者——负责从Kafka抓去未处理事件，通过调用业务逻辑处理单元完成后续持久化操作。这样一个账户的所有业务操作都可以有完整的快照历史，符合金融业务Audit（审计）的需要。而且通过使用事件，我们可以很方便地重建数据。</p>
<p><strong>业务事件列表：</strong></p>
<ul>
<li>CreateEvent：开户</li>
<li>DepositEvent：存款</li>
<li>WithdrawEvent：取款</li>
<li>TransferEvent：转账</li>
</ul>
<p><strong>领域模型：账户（Account）</strong><br>holder’s name:持有人名称<br>balance：余额<br>registration date：开户日期<br>……</p>
<p><strong>领域模型：事件（Event）</strong><br>name:事件名称<br>ID：序号<br>……</p>
<p><img src="http://omb2onfvy.bkt.clouddn.com/MicroService_EventSourcing_Classes.png" alt=""></p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><ul>
<li>第一步，启动<a href="https://zookeeper.apache.org/" target="_blank" rel="external">ZooKeeper</a>:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ wget http://mirror.bit.edu.cn/apache/kafka/0.10.1.0/kafka_2.10-0.10.1.0.tgz</div><div class="line">$ tar -xvf kafka_2.10-0.10.1.0.tgz</div><div class="line">$ <span class="built_in">cd</span> kafka_2.10-0.10.1.0</div><div class="line">$ bin/zookeeper-server-start.sh config/zookeeper.properties</div><div class="line">$ netstat -an | grep 2181</div><div class="line">tcp46      0      0  *.2181                 *.*                    LISTEN</div></pre></td></tr></table></figure>
<ul>
<li><p>第二步，启动<a href="https://kafka.apache.org/" target="_blank" rel="external">Kafka</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$ bin/kafka-server-start.sh config/server.properties   </div><div class="line"></div><div class="line">[2017-06-13 14:03:08,168] INFO New leader is 0 (kafka.server.ZookeeperLeaderElector<span class="variable">$LeaderChangeListener</span>)</div><div class="line">[2017-06-13 14:03:08,172] INFO Kafka version : 0.10.1.0 (org.apache.kafka.common.utils.AppInfoParser)</div><div class="line">[2017-06-13 14:03:08,172] INFO Kafka commitId : 3402a74efb23d1d4 (org.apache.kafka.common.utils.AppInfoParser)</div><div class="line">[2017-06-13 14:03:08,173] INFO [Kafka Server 0], started (kafka.server.KafkaServer)</div><div class="line"></div><div class="line">$ lsof -nP -iTCP <span class="_">-s</span>TCP:LISTEN | sort -n</div><div class="line">$ netstat -an | grep 9092</div><div class="line">  tcp46      0      0  *.9092                 *.*                    LISTEN</div></pre></td></tr></table></figure>
</li>
<li><p>第三步，创建topic</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partition 1 --topic x-microservice-transactions-t1</div><div class="line"></div><div class="line">Created topic <span class="string">"x-microservice-transactions-t1"</span>.</div></pre></td></tr></table></figure>
<ul>
<li>另外，运行多个<a href="https://kafka.apache.org/" target="_blank" rel="external">Kafka</a> 实例<br>Kafka多实例非常简单，只需要复制文件 server.properties，稍作修改即可。<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">config/server<span class="number">-1.</span>properties:</div><div class="line">    broker.id=<span class="number">1</span></div><div class="line">    listeners=PLAINTEXT:<span class="comment">//:9093</span></div><div class="line">    log.dir=/tmp/kafka-logs<span class="number">-1</span></div><div class="line"></div><div class="line">config/server<span class="number">-2.</span>properties:</div><div class="line">    broker.id=<span class="number">2</span></div><div class="line">    listeners=PLAINTEXT:<span class="comment">//:9094</span></div><div class="line">    log.dir=/tmp/kafka-logs<span class="number">-2</span></div><div class="line"></div><div class="line"><span class="comment">// 启动多个broker,须指定不同的属性文件</span></div><div class="line">$ bin/kafka-server-start.sh config/server<span class="number">-1.</span>properties</div><div class="line">$ bin/kafka-server-start.sh config/server<span class="number">-2.</span>properties</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="domain-model"><a href="#domain-model" class="headerlink" title="domain model"></a>domain model</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="comment">// domain model: bank_account.go</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> BankAccount <span class="keyword">struct</span> &#123;</div><div class="line">    Id      <span class="keyword">string</span></div><div class="line">    Name    <span class="keyword">string</span></div><div class="line">    Balance <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//定义下列函数：</span></div><div class="line"></div><div class="line"><span class="comment">//1. FetchAccount(id) 从Redis读取账户实例信息</span></div><div class="line"><span class="comment">//2. updateAccount(id, data) 更新指定账户信息</span></div><div class="line"><span class="comment">//3. ToAccount(map) 将从Redis读到的账户信息转换为模型数据，return *BankAccount object.</span></div></pre></td></tr></table></figure>
<h4 id="Kafka-amp-Redis-library"><a href="#Kafka-amp-Redis-library" class="headerlink" title="Kafka &amp; Redis library"></a>Kafka &amp; Redis library</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// main.go</span></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"github.com/go-redis/redis"</span> <span class="comment">// Redis通讯库：go-redis</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> (</div><div class="line">    Redis = initRedis()</div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">initRedis</span><span class="params">()</span> *<span class="title">redis</span>.<span class="title">Client</span></span> &#123;</div><div class="line">    redisUrl := os.Getenv(<span class="string">"REDIS_URL"</span>)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> redisUrl == <span class="string">""</span> &#123;</div><div class="line">        redisUrl = <span class="string">"127.0.0.1:6379"</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> redis.NewClient(&amp;redis.Options&#123;</div><div class="line">        Addr:     redisUrl,</div><div class="line">        Password: <span class="string">""</span>,</div><div class="line">        DB:       <span class="number">0</span>,</div><div class="line">    &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="comment">//kafka.go</span></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"encoding/json"</span></div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"github.com/Shopify/sarama"</span> <span class="comment">//Kafka通讯库：Sarama</span></div><div class="line">    <span class="string">"os"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> (</div><div class="line">    brokers = []<span class="keyword">string</span>&#123;<span class="string">"127.0.0.1:9092"</span>&#125;</div><div class="line">    topic   = <span class="string">"go-microservice-transactions"</span></div><div class="line">    topics  = []<span class="keyword">string</span>&#123;topic&#125;</div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">newKafkaConfiguration</span><span class="params">()</span> *<span class="title">sarama</span>.<span class="title">Config</span></span> &#123;</div><div class="line">    conf := sarama.NewConfig()</div><div class="line">    conf.Producer.RequiredAcks = sarama.WaitForAll</div><div class="line">    conf.Producer.Return.Successes = <span class="literal">true</span></div><div class="line">    conf.ChannelBufferSize = <span class="number">1</span></div><div class="line">    conf.Version = sarama.V0_10_1_0</div><div class="line">    <span class="keyword">return</span> conf</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">newKafkaSyncProducer</span><span class="params">()</span> <span class="title">sarama</span>.<span class="title">SyncProducer</span></span> &#123;</div><div class="line">    kafka, err := sarama.NewSyncProducer(brokers, newKafkaConfiguration())</div><div class="line"></div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Printf(<span class="string">"Kafka error: %s\n"</span>, err)</div><div class="line">        os.Exit(<span class="number">-1</span>)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> kafka</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">newKafkaConsumer</span><span class="params">()</span> <span class="title">sarama</span>.<span class="title">Consumer</span></span> &#123;</div><div class="line">    consumer, err := sarama.NewConsumer(brokers, newKafkaConfiguration())</div><div class="line"></div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Printf(<span class="string">"Kafka error: %s\n"</span>, err)</div><div class="line">        os.Exit(<span class="number">-1</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> consumer</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="消息生产者Producer"><a href="#消息生产者Producer" class="headerlink" title="消息生产者Producer"></a>消息生产者Producer</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="comment">//消息生产者 producer.go</span></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"bufio"</span></div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"os"</span></div><div class="line">    <span class="string">"strconv"</span></div><div class="line">    <span class="string">"strings"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">mainProducer</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> err error</div><div class="line">    reader := bufio.NewReader(os.Stdin)</div><div class="line">    kafka := newKafkaSyncProducer()</div><div class="line"></div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        fmt.Print(<span class="string">"-&gt; "</span>)</div><div class="line">        text, _ := reader.ReadString(<span class="string">'\n'</span>)</div><div class="line">        text = strings.Replace(text, <span class="string">"\n"</span>, <span class="string">""</span>, <span class="number">-1</span>)</div><div class="line">        args := strings.Split(text, <span class="string">"###"</span>)</div><div class="line">        cmd := args[<span class="number">0</span>]</div><div class="line"></div><div class="line">        <span class="keyword">switch</span> cmd &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">"create"</span>:</div><div class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(args) == <span class="number">2</span> &#123;</div><div class="line">                accName := args[<span class="number">1</span>]</div><div class="line">                event := NewCreateAccountEvent(accName)</div><div class="line">                sendMsg(kafka, event)</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                fmt.Println(<span class="string">"Only specify create###Account Name"</span>)</div><div class="line">            &#125;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            fmt.Printf(<span class="string">"Unknown command %s, only: create, deposit, withdraw, transfer\n"</span>, cmd)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            fmt.Printf(<span class="string">"Error: %s\n"</span>, err)</div><div class="line">            err = <span class="literal">nil</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// kafka.go</span></div><div class="line"><span class="comment">// 增加发送消息的方法</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">sendMsg</span><span class="params">(kafka sarama.SyncProducer, event <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">    json, err := json.Marshal(event)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="keyword">return</span> err</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    msgLog := &amp;sarama.ProducerMessage&#123;</div><div class="line">        Topic: topic,</div><div class="line">        Value: sarama.StringEncoder(<span class="keyword">string</span>(json)),</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    partition, offset, err := kafka.SendMessage(msgLog)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Printf(<span class="string">"Kafka error: %s\n"</span>, err)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Printf(<span class="string">"Message: %+v\n"</span>, event)</div><div class="line">    fmt.Printf(<span class="string">"Message is stored in partition %d, offset %d\n"</span>,</div><div class="line">        partition, offset)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="comment">//启动入口，main.go</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    mainProducer()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$  go build</div><div class="line">$ ./go-microservice</div><div class="line">-&gt; create</div><div class="line">Only specify create<span class="comment">###Account Name</span></div><div class="line">-&gt; create<span class="comment">###Yanrui</span></div><div class="line">Message: &#123;Event:&#123;AccId:49a23d27-4ffe-4c86-ab9a-fbc308ecff1c Type:CreateEvent&#125; AccName:Yanrui&#125;</div><div class="line">Message is stored <span class="keyword">in</span> partition 0, offset 0</div><div class="line">-&gt;</div></pre></td></tr></table></figure>
<h1 id="第二部分-消息消费者Consumer及其集群化"><a href="#第二部分-消息消费者Consumer及其集群化" class="headerlink" title="第二部分 消息消费者Consumer及其集群化"></a>第二部分 消息消费者Consumer及其集群化</h1><p>Consumer负责从Kafka加载消息队列。另外，我们需要为每一个事件创建process()函数。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="comment">//processor.go</span></div><div class="line"><span class="keyword">import</span> (</div><div class="line">  <span class="string">"errors"</span></div><div class="line">)</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e CreateEvent)</span> <span class="title">Process</span><span class="params">()</span> <span class="params">(*BankAccount, error)</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> updateAccount(e.AccId, <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</div><div class="line">        <span class="string">"Id"</span>:      e.AccId,</div><div class="line">        <span class="string">"Name"</span>:    e.AccName,</div><div class="line">        <span class="string">"Balance"</span>: <span class="string">"0"</span>,</div><div class="line">    &#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e InvalidEvent)</span> <span class="title">Process</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">  <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e AcceptEvent)</span> <span class="title">Process</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">  <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// other Process() codes ...</span></div></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="comment">//consumer.go</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">mainConsumer</span><span class="params">(partition <span class="keyword">int32</span>)</span></span> &#123;</div><div class="line">    kafka := newKafkaConsumer()</div><div class="line">    <span class="keyword">defer</span> kafka.Close()</div><div class="line">    <span class="comment">//注：开发环境中我们使用sarama.OffsetOldest，Kafka将从创建以来第一条消息开始发送。</span></div><div class="line">    <span class="comment">//在生产环境中切换为sarama.OffsetNewest,只会将最新生成的消息发送给我们。</span></div><div class="line">    consumer, err := kafka.ConsumePartition(topic, partition, sarama.OffsetOldest)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Printf(<span class="string">"Kafka error: %s\n"</span>, err)</div><div class="line">        os.Exit(<span class="number">-1</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">go</span> consumeEvents(consumer)</div><div class="line"></div><div class="line">    fmt.Println(<span class="string">"Press [enter] to exit consumer\n"</span>)</div><div class="line">    bufio.NewReader(os.Stdin).ReadString(<span class="string">'\n'</span>)</div><div class="line">    fmt.Println(<span class="string">"Terminating..."</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Go语言通过goroutine提供了对于并发编程的直接支持，goroutine是Go语言运行库的功能，作为一个函数入口，在堆上为其分配的一个堆栈。所以它非常廉价，我们可以很轻松的创建上万个goroutine，但它们并不是被操作系统所调度执行。除了被系统调用阻塞的线程外，Go运行库最多会启动$GOMAXPROCS个线程来运行goroutine。</p>
<ul>
<li><a href="https://gobyexample.com/goroutines" target="_blank" rel="external">goroutines</a>: A goroutine is a lightweight thread of execution.</li>
<li><a href="https://gobyexample.com/channels" target="_blank" rel="external">channels</a>: Channels are the pipes that connect concurrent goroutines. (&lt;- operator)</li>
<li><a href="https://gobyexample.com/for" target="_blank" rel="external">for</a>: for is Go’s only looping construct. Here are three basic types of for loops.</li>
<li><a href="https://gobyexample.com/select" target="_blank" rel="external">select</a>: Go’s select lets you wait on multiple channel operations.</li>
<li><a href="https://gobyexample.com/non-blocking-channel-operations" target="_blank" rel="external">Non-Blocking Channel Operations</a></li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">consumeEvents</span><span class="params">(consumer sarama.PartitionConsumer)</span></span> &#123;</div><div class="line">  <span class="keyword">var</span> msgVal []<span class="keyword">byte</span></div><div class="line">  <span class="keyword">var</span> log <span class="keyword">interface</span>&#123;&#125;</div><div class="line">  <span class="keyword">var</span> logMap <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</div><div class="line">  <span class="keyword">var</span> bankAccount *BankAccount</div><div class="line">  <span class="keyword">var</span> err error</div><div class="line"></div><div class="line">  <span class="keyword">for</span> &#123;</div><div class="line">    <span class="comment">//goruntine exec</span></div><div class="line">      <span class="keyword">select</span> &#123;</div><div class="line">          <span class="comment">// blocking &lt;- channel operator</span></div><div class="line">          <span class="keyword">case</span> err := &lt;-consumer.Errors():</div><div class="line">              fmt.Printf(<span class="string">"Kafka error: %s\n"</span>, err)</div><div class="line">          <span class="keyword">case</span> msg := &lt;-consumer.Messages():</div><div class="line">              msgVal = msg.Value</div><div class="line">          <span class="comment">//</span></div><div class="line">          <span class="keyword">if</span> err = json.Unmarshal(msgVal, &amp;log); err != <span class="literal">nil</span> &#123;</div><div class="line">                fmt.Printf(<span class="string">"Failed parsing: %s"</span>, err)</div><div class="line">          &#125; <span class="keyword">else</span> &#123;</div><div class="line">                logMap = log.(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</div><div class="line">                logType := logMap[<span class="string">"Type"</span>]</div><div class="line">                fmt.Printf(<span class="string">"Processing %s:\n%s\n"</span>, logMap[<span class="string">"Type"</span>], <span class="keyword">string</span>(msgVal))</div><div class="line"></div><div class="line">                <span class="keyword">switch</span> logType &#123;</div><div class="line">                <span class="keyword">case</span> <span class="string">"CreateEvent"</span>:</div><div class="line">                  event := <span class="built_in">new</span>(CreateEvent)</div><div class="line">                  <span class="keyword">if</span> err = json.Unmarshal(msgVal, &amp;event); err == <span class="literal">nil</span> &#123;</div><div class="line">                    bankAccount, err = event.Process()</div><div class="line">                  &#125;</div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                  fmt.Println(<span class="string">"Unknown command: "</span>, logType)</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">                  fmt.Printf(<span class="string">"Error processing: %s\n"</span>, err)</div><div class="line">                  &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    fmt.Printf(<span class="string">"%+v\n\n"</span>, *bankAccount)</div><div class="line">                  &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="重构main"><a href="#重构main" class="headerlink" title="重构main"></a>重构main</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="comment">//main.go</span></div><div class="line"><span class="comment">//支持producer和consumer启动模式</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"flag"</span></div><div class="line">    ...</div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    act := flag.String(<span class="string">"act"</span>, <span class="string">"producer"</span>, <span class="string">"Either: producer or consumer"</span>)</div><div class="line">    partition := flag.String(<span class="string">"partition"</span>, <span class="string">"0"</span>,</div><div class="line">        <span class="string">"Partition which the consumer program will be subscribing"</span>)</div><div class="line"></div><div class="line">    flag.Parse()</div><div class="line"></div><div class="line">    fmt.Printf(<span class="string">"Welcome to go-microservice : %s\n\n"</span>, *act)</div><div class="line"></div><div class="line">    <span class="keyword">switch</span> *act &#123;</div><div class="line">    <span class="keyword">case</span> <span class="string">"producer"</span>:</div><div class="line">        mainProducer()</div><div class="line">    <span class="keyword">case</span> <span class="string">"consumer"</span>:</div><div class="line">        <span class="keyword">if</span> part32int, err := strconv.ParseInt(*partition, <span class="number">10</span>, <span class="number">32</span>); err == <span class="literal">nil</span> &#123;</div><div class="line">            mainConsumer(<span class="keyword">int32</span>(part32int))</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过–act参数，可以启动一个消费者进程。当进程运行时，他将从Kafka一个一个拿出消息进行处理，按照我们之前在每个事件定义的Process() 方法。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$ go build</div><div class="line">$ ./go-microservice --act=consumer</div><div class="line">Welcome to go-microservice : consumer</div><div class="line"></div><div class="line">Press [enter] to <span class="built_in">exit</span> consumer</div><div class="line"></div><div class="line">Processing CreateEvent:</div><div class="line">&#123;<span class="string">"AccId"</span>:<span class="string">"49a23d27-4ffe-4c86-ab9a-fbc308ecff1c"</span>,<span class="string">"Type"</span>:<span class="string">"CreateEvent"</span>,<span class="string">"AccName"</span>:<span class="string">"Yanrui"</span>&#125;</div><div class="line">&#123;Id:49a23d27-4ffe-4c86-ab9a-fbc308ecff1c Name:Yanrui Balance:0&#125;</div><div class="line">Terminating...</div></pre></td></tr></table></figure>
<h3 id="集群化消息消费者"><a href="#集群化消息消费者" class="headerlink" title="集群化消息消费者"></a>集群化消息消费者</h3><p>问题：如果一个Consumer宕机了怎么办？（例如：程序崩溃、网络异常等原因）<br>解决方案：将多个Consumer编组为集群实现高可用。具体来说就是打标签，当有一个新的Log发送时，Kafka将其发送给其中一个实例。当该实例无法接收Log时，Kafka将Log传递给另一个包含相同标签的Consumer。<br>注意：Kafka 版本 0.9 +，另外还需要使用sarama-cluster库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#使用govendor获取</span></div><div class="line">govendor fetch github.com/bsm/sarama-cluster</div></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//修改mainConsumer方法使用sarama-cluster library连接Kafka</span></div><div class="line">config := cluster.NewConfig()</div><div class="line">config.Consumer.Offsets.Initial = sarama.OffsetNewest</div><div class="line">consumer, err := cluster.NewConsumer(brokers, <span class="string">"go-microservice-consumer"</span>, topics, config)</div><div class="line"></div><div class="line"><span class="comment">//topics定义</span></div><div class="line"><span class="keyword">var</span> (</div><div class="line">    topics  = []<span class="keyword">string</span>&#123;topic&#125;</div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">//调整consumeEvents()</span></div><div class="line"><span class="keyword">case</span> err, more := &lt;-consumer.Errors():</div><div class="line">    <span class="keyword">if</span> more &#123;</div><div class="line">        fmt.Printf(<span class="string">"Kafka error: %s\n"</span>, err)</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="comment">//consumer.Messages() : MarkOffset</span></div><div class="line"><span class="comment">//consumer.go</span></div><div class="line"><span class="comment">//func mainConsumer(partition int32)</span></div><div class="line"></div><div class="line">consumer.MarkOffset(msg, <span class="string">""</span>) <span class="comment">//增加的行</span></div><div class="line"></div><div class="line">msgVal = msg.Value</div></pre></td></tr></table></figure>
<p>即使程序崩溃，MarkOffset也会将消息标记为 <strong>processed</strong> ,标签包括元数据以及这个时间点的状态。元数据可以被另外一个Consumer恢复数据状态，也就能被重新消费。即即使同样的消息被处理两次，结果也是一样的，这个过程理论上是 <strong>幂等</strong> 的（idempotent）。</p>
<p><img src="http://omb2onfvy.bkt.clouddn.com/MicroService_Kafka_Consumers.jpg" alt="Kafka Consumers"></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//运行多个consumer实例</span></div><div class="line">$ ./<span class="keyword">go</span>-microservice --act=consumer</div><div class="line">$ ./<span class="keyword">go</span>-microservice --act=consumer</div><div class="line">$ ./<span class="keyword">go</span>-microservice --act=consumer</div></pre></td></tr></table></figure>
<h1 id="第三部分：测试驱动开发、Docker部署和持续集成"><a href="#第三部分：测试驱动开发、Docker部署和持续集成" class="headerlink" title="第三部分：测试驱动开发、Docker部署和持续集成"></a>第三部分：测试驱动开发、Docker部署和持续集成</h1><h4 id="使用vendor管理Golang项目依赖"><a href="#使用vendor管理Golang项目依赖" class="headerlink" title="使用vendor管理Golang项目依赖"></a>使用vendor管理Golang项目依赖</h4><p>用govendor fetch <url1> <url2>新增的第三方包直接被get到根目录的vendor文件夹下,不会与其它的项目混用第三方包，完美避免多个项目同用同一个第三方包的不同版本问题。只需要对vendor/vendor.json进行版本控制，即可对第三包依赖关系进行控制。</url2></url1></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ <span class="comment">//</span></div><div class="line">$ <span class="keyword">go</span> get -u github.com/kardianos/govendor</div><div class="line">$ cd $PROJECT_PATH</div><div class="line">$ govendor init</div><div class="line">$ govendor add +external</div><div class="line">$</div></pre></td></tr></table></figure>
<h4 id="单元测试：ginkgo-Test-Suite"><a href="#单元测试：ginkgo-Test-Suite" class="headerlink" title="单元测试：ginkgo Test Suite"></a>单元测试：ginkgo Test Suite</h4><ul>
<li><a href="https://onsi.github.io/ginkgo/" target="_blank" rel="external">ginkgo</a></li>
<li><a href="https://onsi.github.io/gomega/" target="_blank" rel="external">gomega</a></li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ <span class="keyword">go</span> get github.com/onsi/ginkgo/ginkgo</div><div class="line">$ <span class="keyword">go</span> get github.com/onsi/gomega</div><div class="line">$ ginkgo bootstrap</div><div class="line">Generating ginkgo test suite bootstrap <span class="keyword">for</span> main in:</div><div class="line">	go_microservice_suite_test.<span class="keyword">go</span></div></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main_test</div><div class="line"><span class="comment">//go_microservice_suite_test.go,单元测试类</span></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"github.com/onsi/ginkgo"</span></div><div class="line">    <span class="string">"github.com/onsi/gomega"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> _ = Describe(<span class="string">"Event"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">    Describe(<span class="string">"NewCreateAccountEvent"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        It(<span class="string">"can create a create account event"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">            name := <span class="string">"John Smith"</span></div><div class="line"></div><div class="line">            event := NewCreateAccountEvent(name)</div><div class="line"></div><div class="line">            Expect(event.AccName).To(Equal(name))</div><div class="line">            Expect(event.AccId).NotTo(BeNil())</div><div class="line">            Expect(event.Type).To(Equal(<span class="string">"CreateEvent"</span>))</div><div class="line">        &#125;)</div><div class="line">    &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$ ginkgo</div><div class="line">Running Suite: go-microservice Suite</div><div class="line">==========================</div><div class="line">Random Seed: 1490709758</div><div class="line">Will run 1 of 1 specs</div><div class="line">Ran 1 of 1 Specs <span class="keyword">in</span> 0.000 seconds</div><div class="line">SUCCESS! -- 1 Passed | 0 Failed | 0 Pending | 0 Skipped PASS</div><div class="line">Ginkgo ran 1 suite <span class="keyword">in</span> 905.68195ms</div><div class="line">Test Suite Passed</div></pre></td></tr></table></figure>
<h4 id="单元测试的四个阶段"><a href="#单元测试的四个阶段" class="headerlink" title="单元测试的四个阶段"></a>单元测试的四个阶段</h4><ol>
<li>Setup 启动</li>
<li>Execution 执行</li>
<li>Verification 验证</li>
<li>Teardown 拆卸</li>
</ol>
<h3 id="Docker部署"><a href="#Docker部署" class="headerlink" title="Docker部署"></a>Docker部署</h3><p><a href="https://www.docker.com" target="_blank" rel="external">Docker</a> 容器中需要包含下列组件：</p>
<ol>
<li>Golang</li>
<li>Redis、Kafka</li>
<li>微服务依赖的其它组件</li>
</ol>
<p>在根目录创建一个Dockerfile<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">FROM golang:1.8.0</div><div class="line">MAINTAINER Yanrui</div></pre></td></tr></table></figure></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//install our dependencies</span></div><div class="line">RUN <span class="keyword">go</span> get -u github.com/kardianos/govendor</div><div class="line">RUN <span class="keyword">go</span> get github.com/onsi/ginkgo/ginkgo</div><div class="line">RUN <span class="keyword">go</span> get github.com/onsi/gomega</div><div class="line"></div><div class="line"><span class="comment">//将整个目录拷贝到容器</span></div><div class="line">ADD . /<span class="keyword">go</span>/src/<span class="keyword">go</span>-microservice</div><div class="line"></div><div class="line"><span class="comment">//检查工作目录</span></div><div class="line">WORKDIR /<span class="keyword">go</span>/src/<span class="keyword">go</span>-microservice</div><div class="line"></div><div class="line"><span class="comment">//安装依赖项</span></div><div class="line">RUN govendor sync</div><div class="line"></div><div class="line"><span class="comment">//测试</span></div><div class="line">$ docker build -t <span class="keyword">go</span>-microservice .</div><div class="line">$ docker run -i -t <span class="keyword">go</span>-microservice /bin/bash</div><div class="line">$ ginkgo</div><div class="line">.......................</div><div class="line">.......Failed..........</div></pre></td></tr></table></figure>
<p>由于容器本地并没有一个<a href="https://redis.io" target="_blank" rel="external">Redis</a>实例运行在上面，这时运行ginkgo测试就会报错。我们为什么不在这个Dockerfile中包含一个<a href="https://redis.io" target="_blank" rel="external">Redis</a>呢？这就违背了Docker分层解耦的初衷，我们可以通过docker-compose将两个服务连接起来一起工作。</p>
<p>创建一个docker-compose.yml文件（与Dockerfile目录一致）:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">version: <span class="string">"2.0"</span></div><div class="line"></div><div class="line">services:</div><div class="line">  app:</div><div class="line">    environment:</div><div class="line">      REDIS_URL: redis:6379</div><div class="line">    build: .</div><div class="line">    working_dir: /go/src/go-microservice</div><div class="line">    links:</div><div class="line">      - redis</div><div class="line">  redis:</div><div class="line">    image: redis:alpine</div></pre></td></tr></table></figure></p>
<p>本地构建完成之后，再次运行 <strong>docker-compose run app ginkgo</strong> 测试通过。</p>
<h3 id="Infrastructure-as-Code-基础设施即代码"><a href="#Infrastructure-as-Code-基础设施即代码" class="headerlink" title="Infrastructure as Code(基础设施即代码)"></a>Infrastructure as Code(基础设施即代码)</h3><blockquote>
<p>The enabling idea of infrastructure as code is that the systems and devices which are used to run software can be treated as if they, themselves, are software. — Kief Morris</p>
</blockquote>
<p>云带来的好的一方面是它让公司中的任何人都可以轻松部署、配置和管理他们需要的基础设施。虽然很多基础设施团队采用了云和自动化技术，却没有采用相应的自动化测试和发布流程。它们把这些当作一门过于复杂的脚本语言来使用。他们会为每一次具体的改动编写手册、配置文件和执行脚本，再针对一部分指定的服务器手工运行它们，也就是说每一次改动都还需要花费专业知识、时间和精力。这种工作方式意味着基础设施团队没有把他们自己从日常的重复性劳动中解放出来。目前已经有很多商业云平台提供了Docker服务，只需要将自己的 <strong>git repository</strong> 链接到平台，即可以自动帮你完成部署，在云上完成集成测试。</p>
<p><img src="http://omb2onfvy.bkt.clouddn.com/MicroService_UseDocker.jpg" alt=""></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">docker-compose build</div><div class="line">docker-compose run app ginkgo</div></pre></td></tr></table></figure>
<p><img src="http://omb2onfvy.bkt.clouddn.com/MicroService_CloudTest.png" alt=""></p>
<h2 id="扩展阅读：开源架构技术漫谈"><a href="#扩展阅读：开源架构技术漫谈" class="headerlink" title="扩展阅读：开源架构技术漫谈"></a>扩展阅读：开源架构技术漫谈</h2><ul>
<li><a href="https://riboseyim.github.io/2017/07/23/CloudComputing/" target="_blank" rel="external">Stack Overflow：2017年最赚钱的编程语言</a></li>
<li><a href="https://riboseyim.github.io/2018/04/27/DevOps-OpenCensus" target="_blank" rel="external">DevOps 漫谈：基于OpenCensus构建分布式跟踪系统</a></li>
<li><a href="https://riboseyim.github.io/2017/05/23/RestfulAPI/" target="_blank" rel="external">基于Go语言快速构建一个RESTful API服务</a></li>
<li><a href="https://riboseyim.github.io/2017/06/12/OpenSource-Kafka-Microservice/" target="_blank" rel="external">基于Kafka构建事件溯源型微服务</a></li>
<li><a href="https://riboseyim.github.io/2017/10/30/Protocol-gRPC/" target="_blank" rel="external">远程通信协议：从 CORBA 到 gRPC</a></li>
<li><a href="https://riboseyim.github.io/2017/05/24/Log/" target="_blank" rel="external">应用程序开发中的日志管理(Go语言描述)</a></li>
<li><a href="https://riboseyim.github.io/2017/12/04/Visualization-Graphite/" target="_blank" rel="external">数据可视化（七）Graphite 体系结构详解</a></li>
<li><a href="https://riboseyim.github.io/2016/11/26/DTrace/" target="_blank" rel="external">动态追踪技术(一)：DTrace 导论</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MjM5MTY1MjQ3Nw==&amp;mid=2651939588&amp;idx=1&amp;sn=35f71c5f88d1edf23cb2efc812ab8e6c&amp;chksm=bd578c168a20050041c08618281691f0111f61c789097a69095933057618637fc54817815921#rd" target="_blank" rel="external">动态追踪技术(二)：strace+gdb 溯源 Nginx 内存溢出异常 </a></li>
<li><a href="https://riboseyim.github.io/2017/04/17/DTrace_FTrace/" target="_blank" rel="external">动态追踪技术(三)：Tracing Your Kernel Function!</a></li>
<li><a href="https://riboseyim.github.io/2017/06/27/DTrace_bcc/" target="_blank" rel="external">动态追踪技术(四)：基于 Linux bcc/BPF 实现 Go 程序动态追踪</a></li>
<li><a href="https://riboseyim.github.io/2018/02/16/DTrace-Linux/" target="_blank" rel="external">动态追踪技术(五)：Welcome DTrace for Linux</a></li>
<li><a href="https://riboseyim.github.io/2016/08/15/OpenSource-Kafka/" target="_blank" rel="external">DevOps 资讯 | LinkedIn 开源 Kafka Monitor</a></li>
</ul>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><h4 id="Theory"><a href="#Theory" class="headerlink" title="Theory"></a>Theory</h4><ul>
<li><a href="http://www.melconway.com/Home/Conways_Law.html" target="_blank" rel="external">康威定律</a></li>
<li><a href="http://www.infoq.com/cn/presentations/team-building-implementation-in-distributed-world" target="_blank" rel="external">Mike Amundsen 《远距离条件下的康威定律——分布式世界中实现团队构建》</a></li>
<li><a href="http://shop.oreilly.com/product/0636920039297.do" target="_blank" rel="external">Kief Morris《Infrastructure as Code - Managing Servers in the Cloud》</a></li>
<li><a href="http://www.infoq.com/cn/articles/book-infrastructure-as-code" target="_blank" rel="external">InfoQ:《Infrastructure as Code》书评与摘要</a><h4 id="Microservices"><a href="#Microservices" class="headerlink" title="Microservices"></a>Microservices</h4></li>
<li><a href="https://martinfowler.com/articles/microservices.html" target="_blank" rel="external">(推荐)Martin Fowler : Microservices</a></li>
<li><a href="http://dockone.io/article/2133" target="_blank" rel="external">李颖杰：为什么要重构到微服务（案例）</a><h4 id="Event-Sourcing"><a href="#Event-Sourcing" class="headerlink" title="Event Sourcing"></a>Event Sourcing</h4></li>
<li><a href="https://semaphoreci.com/community/tutorials/writing-and-testing-an-event-sourcing-microservice-with-kafka-and-go" target="_blank" rel="external">(推荐) Writing and Testing an Event Sourcing Microservice with Kafka and Go</a></li>
<li><a href="https://www.linkedin.com/in/adampahlevi/" target="_blank" rel="external">Linkedin Profile:Adam Pahlevi Baihaqi</a></li>
<li><a href="https://medium.com/technology-learning/event-sourcing-and-cqrs-a-look-at-kafka-e0c1b90d17d8" target="_blank" rel="external">(推荐) OKONKWO VINCENT IKEM:Building Scalable Applications Using Event Sourcing and CQRS</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/architecture/patterns/event-sourcing" target="_blank" rel="external">(推荐)Microsoft Azure:Event Sourcing</a></li>
<li><a href="http://agiledon.github.io/blog/2012/12/31/basic-understanding-on-cqrs/" target="_blank" rel="external">张逸:对CQRS的基础理解</a></li>
<li><a href="http://www.cnblogs.com/netfocus/archive/2011/10/10/2204949.html" target="_blank" rel="external">汤雪华：领域驱动设计之领域模型</a></li>
<li><a href="http://www.cnblogs.com/netfocus/archive/2012/02/12/2347911.html" target="_blank" rel="external">汤雪华：什么是事件溯源（Event Sourcing）</a></li>
<li><a href="https://www.infoq.com/news/2016/04/event-sourcing-anti-pattern" target="_blank" rel="external">InfoQ:A Whole System Based on Event Sourcing is an Anti-Pattern</a><h4 id="Zookeeper-amp-Kafka"><a href="#Zookeeper-amp-Kafka" class="headerlink" title="Zookeeper &amp; Kafka"></a>Zookeeper &amp; Kafka</h4></li>
<li><a href="https://kafka.apache.org/quickstart" target="_blank" rel="external">Kafka QuickStart</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/KAFKA/Kafka+0.9+Consumer+Rewrite+Design" target="_blank" rel="external">Apache.org:Kafka 0.9 Consumer Rewrite Design</a></li>
<li><a href="https://www.quora.com/What-is-the-actual-role-of-ZooKeeper-in-Kafka" target="_blank" rel="external">Quora:What is the actual role of ZooKeeper in Kafka?</a></li>
<li><a href="http://grokbase.com/t/kafka/users/135mk77x9q/relationship-between-zookeeper-and-kafka" target="_blank" rel="external">grokbase:Relationship between Zookeeper and Kafka</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzA3MjEyNTE4MQ==&amp;mid=403459151&amp;idx=1&amp;sn=640ba3d9ea70e23ace8b99aff764e42f&amp;scene=1&amp;srcid=01050dYirNIOQVUTLyiBw1j6#rd" target="_blank" rel="external">朱赟:白话 IT 之要不要从 rabbitMQ 转 kafka？</a></li>
</ul>

      

    </div>
    
  </div>
  
    <div class="article-entry" itemprop="articleBody">
      <p>
        更多精彩内容扫码关注公众号,RiboseYim's Blog：<a href="https://riboseyim.github.io" target="_blank" rel="external">https://riboseyim.github.io</a>
        <br>
        <a href="http://o8m8ngokc.bkt.clouddn.com/ID_RiboseYim_201706.png" title="微信公众号@睿哥杂货铺" rel="fancy-group" class="fancy-ctn fancybox">
          <img src="http://o8m8ngokc.bkt.clouddn.com/ID_RiboseYim_201706.png" title="微信公众号@睿哥杂货铺">
          <img src="http://o8m8ngokc.bkt.clouddn.com/quanzi-rui-small.png" title="睿哥读书会">
        </a>
      </p>
    </div>
    
<nav id="article-nav">
  
    <a href="/2017/06/14/Mathmetics/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Catalog:数学与算法
        
      </div>
    </a>
  
  
    <a href="/2017/06/03/Writing-WriterToolChain/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">我的写作工具链</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		  <a href="https://creativecommons.org/licenses/by-nc-nd/4.0" target="_blank">Copyright 2016-2018 RiboseYim
      授权：保持署名-非商业性使用-禁止演绎| License BY-NC-ND 4.0 </a>
    </div>
      	<div class="footer-right">
      		<a href="https://riboseyim.github.io/2016/05/31/AboutMe/" target="_blank"> 联系作者 </a>
      	</div>
    </div>
  </div>
</footer>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1258500076'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1258500076%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: true
	}
</script>
<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>